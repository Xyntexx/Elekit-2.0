name: Auto-Push schematic PDF to Repo

on:
  push:
    branches:
      - main  # Adjust the branch name as needed
jobs:
  Generate_kicad_files:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Check for Auto Tag
        id: auto_tag_check
        run: |
          # Check if the latest commit message contains an autogenerated tag
          if [[ $(git log --format=%B -n 1 $GITHUB_SHA) == *"[AUTO]"* ]]; then
            echo "Push contains an autogenerated tag. Skipping PDF generation..."
            exit 78  # Exit with a neutral status code
          fi
      - name: Check for Schematics Modification
        id: schematics_check
        run: |
          # Check if the schematics file has been modified in the last commit
          if git diff --quiet HEAD^ HEAD -- ./Elekit2.0.kicad_sch; then
            echo "Schematics file not modified. Skipping PDF generation..."
            exit 78  # Exit with a neutral status code
          fi

      - uses: actions-for-kicad/setup-kicad@v1.0
        with:
          version: '7.0'
      - uses: actions-for-kicad/generate-kicad-files@v1.0
        with:
          file: './Elekit2.0.kicad_sch'
          type: 'schematic_pdf'
      - name: Rename Artifacts
        run: |
          rm -f output/schematic.pdf
          mv ./Elekit2.0.kicad_sch output/schematic.pdf
      - name: Commit and Push PDF
        if: steps.auto_tag_check.outcome != 'success' && steps.schematics_check.outcome != 'success'
        run: |
          # Commit the new PDF file
          git config user.name "Actions"
          git config user.email "youremail@example.com"
          git add your-pdf-file.pdf
          git commit -m "Add PDF [AUTO]"
          git tag -a "v$(date +'%Y%m%d%H%M%S')" -m "Autogenerated tag"
          git push origin main --follow-tags
